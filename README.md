# 湖底レンズ (Kotei Lens)

## 概要

「湖底レンズ」は、東京都奥多摩町の小河内ダム湖（奥多摩湖）の底に沈んだ旧小河内村の在りし日の姿を、イマーシブな3D空間で蘇らせるWebアプリケーションです。

スマートフォンやタブレットのGPS位置情報、ジャイロセンサー、方位磁針を活用し、まるでダムがない時代にタイムスリップしたかのような体験を提供します。デバイスを向けた方向に応じて3D空間の視点が変化し、かつて存在した建物や道、風景を探索できます。最新のWebGPU技術により、リアルで美しい村の姿を再現します。

## 背景

小河内ダムは1957年に完成し、東京都の水源として重要な役割を果たしています。しかし、その建設により945世帯の集落が湖底に沈みました。このプロジェクトは、テクノロジーを通じて失われた故郷の記憶を保存し、次世代に伝えることを目的としています。

## 主な機能

- **イマーシブ3Dビュー**: デバイスの向きに連動し、その方向に存在した建物や風景を3D空間で表示
- **GPS連動**: 現在地に基づいて、当時の村の中での位置を特定
- **2Dマップビュー**: Leafletとクラスタリングによるピン表示で、情報地点を一覧できる地図ビュー
- **民話オーディオプレーヤー**: 小河内村に伝わる10話の民話を音声で再生
- **ピン情報表示**: 歴史・インタビュー・民話・伝統芸能・現代の5カテゴリに対応し、画像・外部リンク付きの詳細ドロワーで情報を表示
- **水面降下アニメーション**: ダムの水面が下降し、湖底に沈んだ村の姿が現れる演出
- **地形連動カメラ**: 3Dモデルの地形高さに合わせたカメラ・ピンの高さ自動調整
- **古地図オーバーレイ**: 透明度を調整しながら当時の地図を重ねて表示

## 技術スタック

- **言語**: TypeScript 5.4+
- **フレームワーク**: React 18.3+ with React Three Fiber
- **3Dレンダリング**: Three.js r163+ (WebGPU/WebGL2)
- **状態管理**: Zustand
- **ビルドツール**: Vite 5.2+
- **ルーティング**: React Router DOM
- **アニメーション**: Framer Motion
- **3Dユーティリティ**: @react-three/drei
- **UI**: vaul (ドロワー), react-icons (アイコン)
- **地図/位置情報**: Leaflet, Geolocation API
- **デバイスセンサー**: DeviceOrientation API, DeviceMotion API
- **アクセス解析**: Google Analytics (gtag.js)
- **ホスティング**: GitHub Pages + CDN
- **データ形式**: glTF 2.0 (Draco圧縮、KTX2テクスチャ対応), JSON

## 使い方

1. スマートフォンまたはタブレットで本サイトにアクセス
2. 位置情報とセンサーへのアクセスを許可
3. 小河内ダム周辺でアプリを起動
4. デバイスを様々な方向に向けて、かつての村の姿を探索

## 開発状況

主要機能の実装が完了し、現地での体験テストおよび機能拡張を進めている段階です。詳細な開発計画については[開発ロードマップ](docs/roadmap.md)をご覧ください。

## ドキュメント

- [技術仕様書](docs/technical-spec.md)
- [UI/UXデザイン仕様](docs/ui-ux-spec.md)
- [データ仕様](docs/data-spec.md)
- [開発ロードマップ](docs/roadmap.md)
- [コンポーネント仕様](docs/components/)
  - [Scene3D コンポーネント](docs/components/scene3d.md)
  - [useSensors フック](docs/components/use-sensors.md)
  - [Toast コンポーネント](docs/components/toast.md)
  - [地形モデルの座標系](docs/components/lake-model-coordinates.md)
- [センサーサービス](docs/services/sensors.md)
- [3D方位システム](docs/3d_orientation/orientation_system.md)

## 貢献

このプロジェクトへの貢献を歓迎します。特に以下の分野でのご協力を求めています：

- 小河内村の歴史資料・写真・証言の提供
- 3D モデリング
- UI/UX デザイン
- プログラミング
- ドキュメント作成・翻訳

## ライセンス

MIT License

## TODO

### 優先度1: 基礎データ・基本UI（他の機能の前提となるもの）
- [x] **小河内神社の座標を定義する**（69行目の前提データ）
- [x] **画面中央位置に十字マークを表示する**（70行目 - シンプルで独立、他の機能の視覚的基準になる）

### 優先度2: 基本動作（アプリ起動時の動作）
- [x] **アプリ開始時、エリア内の場合、自分のGPS位置を画面の中心とする**（68行目）
- [x] **アプリ開始時、エリア外であれば、小河内神社を画面の中心とする**（69行目）
- [x] **エリア内の場合、自分のGPS位置を表示する**（67行目 - エリア判定は既に実装済み）

### 優先度3: 既存機能の拡張（既存コードを活用できるもの）
- [x] **古地図の透明度を調整できるようにする**（80行目 - 既存のoverlayOpacityを活用、独立した機能）
- [x] **情報リストの一つを選択でき、その位置に選択情報ピンを表示する**（72行目 - 既存のOkutamaMap2Dを拡張）
  - [x] 同じ情報を押下することで、選択を解除できる（73行目）

### 優先度4: VR機能の拡張（3Dビューの機能追加）
- [x] **VRモードで、情報位置を表示する**（74行目 - 既存のLocationBasedObjectsを拡張）
  - [x] devモードで2Dマップ上のピン位置を3Dビューに表示（実装済み）
  - [x] 自分の位置からある一定距離内の情報地点で、画面中心に一番近いもののラベルが表示される（75行目 - 全表示で実装）
- [x] **VRモードで、情報地点の表示に加え、選択情報ピンが表示される**（76行目 - 選択機能に依存）
  - [x] devモードでピンにラベル（名称）を表示（78行目 - Textコンポーネントを使用）
  - [x] ピンに距離（キロメートル表示）を表示（77行目）
  - [ ] 選択情報ピンを探しやすいよう、画面外の場合、画面の上下左右に矢印が表示される（79行目）

### 優先度5: 高度な機能（複数の機能に依存、実装が複雑）
- [x] **VRで立つ位置での高さは、3dモデルのその地点を高さにする**（71行目 - 3Dモデルとの連携が必要）
  - [x] カメラの高さを地形に合わせて調整（地形+10m、設定ファイルで調整可能）
  - [x] ピンの高さも地形に合わせて調整（地形+10m、設定ファイルで調整可能）
  - [x] 水面の降下アニメーションの高さを地形スケールと連動
  - [x] 水面の干上がりアニメーションの実装（レンダリング後1秒待機、120秒かけて地形の一番下から5m下まで下降）
  - [x] 2D↔3D切り替え後のアニメーション開始問題の修正
- [x] **アプリ開始時に、devモード、本番モードを指定できるようにする**（66行目 - 既にタップ方式で実装済み、UI改善のみ）