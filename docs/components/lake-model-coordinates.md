# 地形モデルの座標系と配置

## 概要

地形モデル（`LakeModel`）の座標系と、3D空間への配置方法について説明します。

## 問題の背景

地形モデルを3D空間に配置する際、モデルファイル自体が大きなオフセットを持っているため、単純に配置すると地形が原点から大きく離れた位置に表示されてしまう問題がありました。

## 座標系の詳細

### 1. モデルファイルの座標系

地形モデルファイル（`OkutamaLake_realscale.glb`）は、以下の座標系で作成されています：

- **バウンディングボックス（terrainScale適用前）**:
  - 最小値: `{x: -15521.001571798653, y: 782.8444397751882, z: -0.00007871077104937285}`
  - 最大値: `{x: 0.00007871077104937285, y: 2908.810977533547, z: 15521.001571798653}`
  - 中心点: `{x: -7760.500746543941, y: 1845.8277086543676, z: 7760.500746543941}`
  - サイズ: `{x: 15521.001650509425, y: 2125.9665377583588, z: 15521.001650509425}`

### 2. terrainScale適用後の座標系

地形モデルには `terrainScale=[10, 10, 10]` が適用されます。Three.jsのスケールは原点を中心に適用されるため、中心点もスケール倍されます。

**理論値（計算上）**:
- 中心点: `{x: -77605.00746543941, y: 18458.277086543676, z: 77605.00746543941}`

**実際の値（ログから取得）**:
- 最小値: `{x: -1490.0000738771196, y: 75.1522144471237, z: -0.00007871077104937285}`
- 最大値: `{x: 0.00007871077104937285, y: 279.242809692485, z: 1490.0000738771196}`
- 中心点: `{x: -744.9999975831743, y: 177.19751206980436, z: 744.9999975831743}`
- サイズ: `{x: 1490.0001525878906, y: 204.09059524536133, z: 1490.0001525878906}`

> **注意**: 理論値と実際の値が大きく異なる理由は、モデルファイル自体が既にスケールや変換が適用されている可能性があるためです。そのため、実際のバウンディングボックスを取得して使用する必要があります。

### 3. 3D空間への配置

地形モデルの中心を3D空間の原点（`[0, 0, 0]`）に配置するため、`LakeModel`コンポーネントの`position`プロパティで補正を行います。

**現在の設定**:
```typescript
<LakeModel 
  position={[744.9999975831743, -177.19751206980436, -744.9999975831743]}
  terrainScale={[10, 10, 10]}
  // ...
/>
```

この`position`は、`terrainScale`適用後の実際の中心点の符号を反転させた値です：
- X座標: `-(-744.9999975831743) = 744.9999975831743`
- Y座標: `-(177.19751206980436) = -177.19751206980436`
- Z座標: `-(744.9999975831743) = -744.9999975831743`

これにより、地形の中心が3D空間の原点に配置されます。

## 座標変換の流れ

1. **GPS座標 → 3D座標**: `gpsToWorldCoordinate()`関数を使用
   - `SCENE_CENTER`（小河内神社: `35.777041, 139.0185245`）を原点`[0, 0, 0]`とする
   - 1単位 = 1メートル

2. **地形モデルの配置**: `LakeModel`の`position`で補正
   - `terrainScale`適用後の実際の中心を原点に配置

3. **カメラの配置**: GPS座標から変換した3D座標を使用
   - カメラの高さは `worldPos.y + 105.73`（人間の目の高さ）

## デバッグ方法

devモードで3Dビューを開くと、以下のログがコンソールに出力されます：

1. **地形のバウンディングボックス（terrainScale適用前）**
2. **地形のバウンディングボックス（terrainScale適用後、実際の値）**
3. **ピンの3D座標**
4. **カメラの初期位置**

これらのログを確認することで、座標系の整合性を検証できます。

## 注意事項

- モデルファイルが変更された場合、`terrainScale`適用後の実際の中心点が変わる可能性があります
- その場合は、ログから実際の値を取得し、`position`を再計算する必要があります
- 理論値ではなく、実際のバウンディングボックスを使用することが重要です

## 関連ファイル

- `src/components/3d/LakeModel.tsx`: 地形モデルの読み込みと表示
- `src/components/viewer/Scene3D.tsx`: 3Dシーンの管理と地形モデルの配置
- `src/utils/coordinate-converter.ts`: GPS座標と3D座標の変換

